From 89320b2fc587f65e630f52592acee2bb7b6e1216 Mon Sep 17 00:00:00 2001
From: Kaan Alsan <alsan@chromium.org>
Date: Wed, 04 Feb 2026 16:44:28 -0800
Subject: [PATCH] Disable split view drop target when dragging a group

If dragging a group with a single tab, the split view drop target will
no longer show.

Change-Id: Ib09456c31b83abd041b7d02fd2c68c53198ee9b7
Bug: 480996768
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/7538019
Commit-Queue: Kaan Alsan <alsan@chromium.org>
Reviewed-by: Caroline Rising <corising@chromium.org>
Reviewed-by: Kaan Alsan <alsan@chromium.org>
Cr-Commit-Position: refs/heads/main@{#1579774}
---

--- a/chrome/browser/ui/views/frame/multi_contents_view_drop_target_controller.cc
+++ b/chrome/browser/ui/views/frame/multi_contents_view_drop_target_controller.cc
@@ -89,8 +89,13 @@ MultiContentsViewDropTargetController::D
 TabDragContext* MultiContentsViewDropTargetController::OnTabDragUpdated(
     TabDragTarget::DragController& controller,
     const gfx::Point& point_in_screen) {
-  // Only allow creating split with a single dragged tab.
-  if (controller.GetSessionData().num_dragging_tabs() != 1) {
+  const auto& drag_data = controller.GetSessionData();
+  // Only allow creating split with a single dragged tab, that is not a tab
+  // group drag (i.e. the tab should not be the only member of its group).
+  // Allowing a group to turn into a split would circumvent the group deletion
+  // flow, such as requesting user confirmation.
+  if (drag_data.num_dragging_tabs() != 1 ||
+      !drag_data.dragging_groups.empty()) {
     ResetDropTargetTimers();
     HideDropTarget();
     return nullptr;
--- a/chrome/browser/ui/views/frame/multi_contents_view_drop_target_controller_unittest.cc
+++ b/chrome/browser/ui/views/frame/multi_contents_view_drop_target_controller_unittest.cc
@@ -279,6 +279,36 @@ TEST_F(MultiContentsViewDropTargetContro
   EXPECT_FALSE(drop_target_view().GetVisible());
 }
 
+// Tests that the drop target is hidden when dragging a group.
+TEST_F(MultiContentsViewDropTargetControllerTest,
+       OnTabDragUpdated_HidesTargetWhenDraggingGroup) {
+  MockTabDragController mock_tab_drag_controller;
+  DragSessionData session_data;
+  MockTabSlotView tab1;
+  MockTabDragContext tab_drag_context;
+  session_data.tab_drag_data_ = {
+      TabDragData(&tab_drag_context, &tab1),
+  };
+  session_data.tab_drag_data_[0].attached_view = &tab1;
+  session_data.dragging_groups.insert(tab_groups::TabGroupId::GenerateNew());
+  EXPECT_CALL(tab1, GetTabSlotViewType)
+      .WillRepeatedly(testing::Return(TabSlotView::ViewType::kTab));
+
+  // Simulate showing the drop target first.
+  DragTabTo(kDragPointForStartDropTargetShow);
+  FastForward(
+      MultiContentsViewDropTargetController::kShowDropTargetForTabDelay);
+  EXPECT_TRUE(drop_target_view().GetVisible());
+
+  // Dragging the group tabs should immediately hide it.
+  EXPECT_CALL(mock_tab_drag_controller, GetSessionData)
+      .WillRepeatedly(testing::ReturnRef(session_data));
+  controller().OnTabDragUpdated(mock_tab_drag_controller,
+                                kDragPointForStartDropTargetShow);
+  FastForward(kHideDropTargetDelay + kHideDropTargetAnimation);
+  EXPECT_FALSE(drop_target_view().GetVisible());
+}
+
 // Tests that the drag updated event is handled correctly for a single tab.
 TEST_F(MultiContentsViewDropTargetControllerTest,
        OnTabDragUpdated_ShowsAndHidesTargetWhenDraggingSingleTab) {
